package com.SDIOS.ServiceControl;

import android.content.Context;

import androidx.test.ext.junit.runners.AndroidJUnit4;
import androidx.test.platform.app.InstrumentationRegistry;

import com.SDIOS.ServiceControl.AnomalyDetection.ClassifiersManager;
import com.SDIOS.ServiceControl.Recycler.ClassifiersPackage;
import com.SDIOS.ServiceControl.utils.ContextHolder;

import org.json.JSONException;
import org.json.JSONObject;
import org.junit.Test;
import org.junit.runner.RunWith;

/**
 * Instrumented test, which will execute on an Android device.
 *
 * @see <a href="http://d.android.com/tools/testing">Testing documentation</a>
 */
@RunWith(AndroidJUnit4.class)
public class BuildModelInstrumentedTest {
    @Test
    public void testBuildApp() throws JSONException {
        String example_model = "{\"package_name\": \"GAF_anomaly_detector\", \"version\": 1.0, \"description\": \"Autoencoder trained on benign SDIOS dataset, converted to GAF\", \"classifiers_map\": [{\"name\": \"x_pipeline\", \"input\": {\"sensors\": [\"gyroscope\"], \"data_collection\": {\"method\": \"time\", \"parameters\": {\"collect_ms\": 2000}}, \"skip_samples\": {\"method\": \"time\", \"parameters\": {\"skip_ms\": 400}, \"user_config\": [{\"var_name\": \"skip_ms\", \"friendly_name\": \"X pipeline - evaluate the events every ms:\", \"type\": \"bar\", \"low\": 0, \"high\": 2000}]}}, \"preprocess\": [{\"method\": \"extract_axes\", \"parameters\": {\"axes\": [\"x\", \"t\"], \"extract_timestamp\": true}}, {\"method\": \"fixed_time\", \"parameters\": {\"samples_per_second\": 60}}, {\"method\": \"enforce_size\", \"parameters\": {\"shape\": [120]}}, {\"method\": \"normalize\", \"parameters\": {\"from_start\": -30, \"from_end\": 30, \"to_start\": -1, \"to_end\": 1}}, {\"method\": \"gaf\", \"parameters\": {\"method\": \"summation\"}}, {\"method\": \"normalize\", \"parameters\": {\"from_start\": -1, \"from_end\": 1, \"to_start\": 0, \"to_end\": 1}}, {\"method\": \"transform_to_tensorflow_buffer\", \"parameters\": {\"type\": \"float32\", \"shape\": [120, 120]}}], \"classifiers\": [\"gyro_x_encoder\", \"gyro_x_decoder\"]}, {\"name\": \"y_pipeline\", \"input\": {\"sensors\": [\"gyroscope\"], \"data_collection\": {\"method\": \"time\", \"parameters\": {\"collect_ms\": 2000}}, \"skip_samples\": {\"method\": \"time\", \"parameters\": {\"skip_ms\": 400}, \"user_config\": [{\"var_name\": \"skip_ms\", \"friendly_name\": \"Y pipeline - evaluate the events every ms:\", \"type\": \"bar\", \"low\": 0, \"high\": 2000}]}}, \"preprocess\": [{\"method\": \"extract_axes\", \"parameters\": {\"axes\": [\"y\", \"t\"], \"extract_timestamp\": true}}, {\"method\": \"fixed_time\", \"parameters\": {\"samples_per_second\": 60}}, {\"method\": \"enforce_size\", \"parameters\": {\"shape\": [120]}}, {\"method\": \"normalize\", \"parameters\": {\"from_start\": -30, \"from_end\": 30, \"to_start\": -1, \"to_end\": 1}}, {\"method\": \"gaf\", \"parameters\": {\"method\": \"summation\"}}, {\"method\": \"normalize\", \"parameters\": {\"from_start\": -1, \"from_end\": 1, \"to_start\": 0, \"to_end\": 1}}, {\"method\": \"transform_to_tensorflow_buffer\", \"parameters\": {\"type\": \"float32\", \"shape\": [120, 120]}}], \"classifiers\": [\"gyro_y_encoder\", \"gyro_y_decoder\"]}, {\"name\": \"z_pipeline\", \"input\": {\"sensors\": [\"gyroscope\"], \"data_collection\": {\"method\": \"time\", \"parameters\": {\"collect_ms\": 2000}}, \"skip_samples\": {\"method\": \"time\", \"parameters\": {\"skip_ms\": 400}, \"user_config\": [{\"var_name\": \"skip_ms\", \"friendly_name\": \"Z pipeline - evaluate the events every ms:\", \"type\": \"bar\", \"low\": 0, \"high\": 2000}]}}, \"preprocess\": [{\"method\": \"extract_axes\", \"parameters\": {\"axes\": [\"z\", \"t\"], \"extract_timestamp\": true}}, {\"method\": \"fixed_time\", \"parameters\": {\"samples_per_second\": 60}}, {\"method\": \"enforce_size\", \"parameters\": {\"shape\": [120]}}, {\"method\": \"normalize\", \"parameters\": {\"from_start\": -30, \"from_end\": 30, \"to_start\": -1, \"to_end\": 1}}, {\"method\": \"gaf\", \"parameters\": {\"method\": \"summation\"}}, {\"method\": \"normalize\", \"parameters\": {\"from_start\": -1, \"from_end\": 1, \"to_start\": 0, \"to_end\": 1}}, {\"method\": \"transform_to_tensorflow_buffer\", \"parameters\": {\"type\": \"float32\", \"shape\": [120, 120]}}], \"classifiers\": [\"gyro_z_encoder\", \"gyro_z_decoder\"]}, {\"name\": \"l2norm_pipeline\", \"input\": {\"sensors\": [\"gyroscope\"], \"data_collection\": {\"method\": \"time\", \"parameters\": {\"collect_ms\": 2000}}, \"skip_samples\": {\"method\": \"time\", \"parameters\": {\"skip_ms\": 400}, \"user_config\": [{\"var_name\": \"skip_ms\", \"friendly_name\": \"L2norm pipeline - evaluate the events every ms:\", \"type\": \"bar\", \"low\": 0, \"high\": 2000}]}}, \"preprocess\": [{\"method\": \"extract_axes\", \"parameters\": {\"axes\": [\"x\", \"y\", \"z\", \"t\"], \"extract_timestamp\": true}}, {\"method\": \"l2norm\", \"parameters\": {\"axes\": [\"x\", \"y\", \"z\"]}}, {\"method\": \"fixed_time\", \"parameters\": {\"samples_per_second\": 60}}, {\"method\": \"enforce_size\", \"parameters\": {\"shape\": [120]}}, {\"method\": \"normalize\", \"parameters\": {\"from_start\": -30, \"from_end\": 30, \"to_start\": -1, \"to_end\": 1}}, {\"method\": \"gaf\", \"parameters\": {\"method\": \"summation\"}}, {\"method\": \"normalize\", \"parameters\": {\"from_start\": -1, \"from_end\": 1, \"to_start\": 0, \"to_end\": 1}}, {\"method\": \"transform_to_tensorflow_buffer\", \"parameters\": {\"type\": \"float32\", \"shape\": [120, 120]}}], \"classifiers\": [\"gyro_l2norm_encoder\", \"gyro_l2norm_decoder\"]}], \"anomaly_detectors\": {\"gyroscope\": {\"analyzer\": {\"method\": \"threshold\", \"parameters\": {\"threshold_amount\": 0.01, \"pipelines\": [\"x_pipeline\", \"y_pipeline\", \"z_pipeline\", \"l2norm_pipeline\"], \"loss\": \"MeanSquaredError\"}, \"user_config\": [{\"var_name\": \"threshold_amount\", \"friendly_name\": \"allowed Loss threshold amount\", \"type\": \"bar\", \"low\": 0, \"high\": 2}]}, \"on_detect_action\": {\"method\": \"block\", \"parameters\": {\"trust_level\": 0.9}, \"user_config\": [{\"var_name\": \"trust_level\", \"friendly_name\": \"allowed trust levels\", \"type\": \"bar\", \"low\": 0, \"high\": 1}]}}}, \"neural_networks\": [{\"name\": \"gyro_x_encoder\", \"method\": \"TensorFlowLiteNeuronalNetwork\", \"parameters\": {\"filename\": \"gyroscope_encoder0.tflite\", \"input_shape\": [120, 120], \"output_shape\": [1024], \"input_type\": \"int\", \"output_type\": \"float\"}}, {\"name\": \"gyro_y_encoder\", \"method\": \"TensorFlowLiteNeuronalNetwork\", \"parameters\": {\"filename\": \"gyroscope_encoder1.tflite\", \"input_shape\": [120, 120], \"output_shape\": [1024], \"input_type\": \"int\", \"output_type\": \"float\"}}, {\"name\": \"gyro_z_encoder\", \"method\": \"TensorFlowLiteNeuronalNetwork\", \"parameters\": {\"filename\": \"gyroscope_encoder2.tflite\", \"input_shape\": [120, 120], \"output_shape\": [1024], \"input_type\": \"int\", \"output_type\": \"float\"}}, {\"name\": \"gyro_l2norm_encoder\", \"method\": \"TensorFlowLiteNeuronalNetwork\", \"parameters\": {\"filename\": \"gyroscope_encoder3.tflite\", \"input_shape\": [120, 120], \"output_shape\": [1024], \"input_type\": \"int\", \"output_type\": \"float\"}}, {\"name\": \"gyro_x_decoder\", \"method\": \"TensorFlowLiteNeuronalNetwork\", \"parameters\": {\"filename\": \"gyroscope_decoder0.tflite\", \"input_shape\": [1024], \"output_shape\": [120, 120], \"input_type\": \"float\", \"output_type\": \"int\"}}, {\"name\": \"gyro_y_decoder\", \"method\": \"TensorFlowLiteNeuronalNetwork\", \"parameters\": {\"filename\": \"gyroscope_decoder1.tflite\", \"input_shape\": [1024], \"output_shape\": [120, 120], \"input_type\": \"float\", \"output_type\": \"int\"}}, {\"name\": \"gyro_z_decoder\", \"method\": \"TensorFlowLiteNeuronalNetwork\", \"parameters\": {\"filename\": \"gyroscope_decoder2.tflite\", \"input_shape\": [1024], \"output_shape\": [120, 120], \"input_type\": \"float\", \"output_type\": \"int\"}}, {\"name\": \"gyro_l2norm_decoder\", \"method\": \"TensorFlowLiteNeuronalNetwork\", \"parameters\": {\"filename\": \"gyroscope_decoder3.tflite\", \"input_shape\": [1024], \"output_shape\": [120, 120], \"input_type\": \"float\", \"output_type\": \"int\"}}]}, {\"package_name\": \"raw_data_autoencoder_anomaly_detector\", \"version\": 1.0, \"description\": \"Autoencoder trained on benign SDIOS dataset\", \"TODO\": \"TODO\", \"neural_networks\": [{\"sensor\": \"gyroscope\", \"filename\": \"gyro.tflite\"}]}";
        // Context of the app under test.
        Context appContext = InstrumentationRegistry.getInstrumentation().getTargetContext();
        ContextHolder.set_context(appContext);
        ClassifiersPackage classifiersPackage = new ClassifiersPackage(new JSONObject(example_model), false);
        ClassifiersManager classifiersManager = new ClassifiersManager(classifiersPackage);
        assert classifiersManager.get_by_name("magnetometer") == null;
        assert classifiersManager.get_by_name("not_exit") == null;
        assert classifiersManager.get_by_name("gyroscope") != null;
    }
}